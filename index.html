<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2025 è¡€è„‚ç®¡ç†æ±ºç­–ç³»çµ± - THAS ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f8f9fa; }
        .risk-tag { width: 110px; text-align: center; }
        #loading-status { color: blue; font-weight: bold; }
        .detail-section { margin-bottom: 1.5rem; }
        .medication-item { font-size: 0.9rem; }
        #ldl-chart { max-height: 250px; margin-top: 1rem; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span>å³æ™‚ç—…æ‚£æ¸…å–® (THAS FHIR Server)</span>
                    <span id="loading-status">è³‡æ–™è®€å–ä¸­...</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>å§“å</th>
                                <th>é¢¨éšªç­‰ç´š</th>
                                <th>æœ€æ–° LDL-C</th>
                                <th>ç›®æ¨™å€¼</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="patient-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div id="detail-pane" class="card shadow-sm p-4" style="display:none; min-height: 650px;">
                <h3 id="det-name" class="text-primary fw-bold"></h3>
                <hr>
                <div class="detail-section">
                    <h6><span class="badge bg-secondary mb-2">è‡¨åºŠè¨ºæ–·</span></h6>
                    <p id="det-cond" class="small mb-0"></p>
                </div>
                
                <div class="detail-section">
                    <h6><span class="badge bg-primary mb-2">LDL-C æŒ‡æ¨™</span></h6>
                    <div class="h4 mb-2">
                        ç›®å‰: <span id="det-ldl" class="text-danger fw-bold"></span> mg/dL 
                        <small class="text-muted">/ ç›®æ¨™: <span id="det-target"></span> mg/dL</small>
                    </div>
                    
                    <!-- é€²åº¦æ¢ï¼šLDL-C é”æˆç™¾åˆ†æ¯” -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>LDL-C é”æˆé€²åº¦</span>
                            <span id="progress-text"></span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æŸ±ç‹€åœ–ï¼šç›®å‰ vs ç›®æ¨™ -->
                <div class="detail-section">
                    <h6><span class="badge bg-info mb-2">LDL-C å·®è·åœ–</span></h6>
                    <canvas id="ldl-chart"></canvas>
                </div>
                
                <div class="detail-section">
                    <h6><span class="badge bg-success mb-2">ç›®å‰ç”¨è—¥æ¸…å–®</span></h6>
                    <ul id="det-medications" class="list-group list-group-flush small"></ul>
                </div>
                
                <div class="alert alert-info mt-3">
                    <strong>2025 å…±è­˜å…·é«”æ²»ç™‚å»ºè­°ï¼š</strong>
                    <pre id="det-advice" class="mb-0 small" style="white-space: pre-wrap; font-family: inherit;"></pre>
                </div>
            </div>
            <div id="placeholder" class="text-center mt-5 text-muted">
                <h5>è«‹é»æ“Šå·¦å´ç—…äººæŸ¥çœ‹è©³ç´°ç—…ä¾‹èˆ‡å»ºè­°</h5>
            </div>
        </div>
    </div>
</div>

<script>
    const FHIR_BASE = "https://thas.mohw.gov.tw/v/r4/fhir";
    
    const patientIds = [
        'liu-dong-cai-001',
        'chen-wei-hua-002',
        'chen-jun-da-003',
        'tsai-xiu-li-004'
    ];
    
    let patientDataStore = {};
    let chartInstance = null; // ç”¨ä¾†å„²å­˜ Chart.js å¯¦ä¾‹ï¼Œé¿å…é‡è¤‡å»ºç«‹

    function hasCondition(conditions, keywords) {
        return conditions.some(cond => {
            const text = (cond.code?.text || '').toLowerCase();
            const coding = cond.code?.coding || [];
            return keywords.some(kw => 
                text.includes(kw.toLowerCase()) ||
                coding.some(c => 
                    (c.code || '').includes(kw) || 
                    (c.display || '').toLowerCase().includes(kw.toLowerCase())
                )
            );
        });
    }

    function calculateRiskLevel(patient, conditions, observations, medications, ldl) {
        let age = 0;
        if (patient.birthDate) {
            const birthDate = new Date(patient.birthDate);
            const today = new Date();
            age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
        }
        const gender = patient.gender || 'unknown';

        const latestObservations = {};
        observations.forEach(obs => {
            const code = obs.code?.coding?.[0]?.code || obs.code?.text || '';
            if (obs.valueQuantity && obs.effectiveDateTime) {
                if (!latestObservations[code] || new Date(obs.effectiveDateTime) > new Date(latestObservations[code].effectiveDateTime)) {
                    latestObservations[code] = obs;
                }
            }
        });

        const ldlC    = latestObservations['13457-7']?.valueQuantity?.value || null;
        const hdlC    = latestObservations['2085-9']?.valueQuantity?.value || null;
        const sysBP   = latestObservations['8480-6']?.valueQuantity?.value || null;
        const diaBP   = latestObservations['8462-4']?.valueQuantity?.value || null;
        const eGFR    = latestObservations['50044-7']?.valueQuantity?.value || latestObservations['69405-9']?.valueQuantity?.value || null;

        let riskFactors = 0;
        if (sysBP >= 130 || diaBP >= 85) riskFactors++;
        if (hdlC && ((gender === 'male' && hdlC < 40) || (gender === 'female' && hdlC < 50))) riskFactors++;
        if (age >= (gender === 'male' ? 45 : 55)) riskFactors++;
        if (hasCondition(conditions, ['æŠ½è¸', 'smoking', 'tobacco'])) riskFactors++;
        if (hasCondition(conditions, ['æ—©ç™¼å®¶æ—å²', 'family history premature CAD'])) riskFactors++;
        if (hasCondition(conditions, ['ä»£è¬ç—‡å€™ç¾¤', 'metabolic syndrome'])) riskFactors++;
        if (hasCondition(conditions, ['è‚¥èƒ–', 'obesity', 'è…¹éƒ¨è‚¥èƒ–'])) riskFactors++;

        let risk = "ä½é¢¨éšª";
        let target = 130;
        let color = "success";
        let advice = "ç”Ÿæ´»å‹æ…‹èª¿æ•´ï¼Œå®šæœŸè¿½è¹¤";

        if (hasCondition(conditions, ['å¤šæ”¯è¡€ç®¡é˜»å¡', 'ä¸€å¹´å…§å¿ƒè‚Œæ¢—å¡', 'â‰¥2æ¬¡å¿ƒè‚Œæ¢—å¡', 'æ€¥æ€§å† å¿ƒç—‡åˆä½µç³–å°¿ç—…', 'å‘¨é‚Šå‹•è„ˆç–¾ç—…åˆä½µå† å¿ƒç—…'])) {
            risk = "æ¥µé«˜é¢¨éšª";
            target = 55;
            color = "danger";
            advice = "1. ç«‹å³èµ·å§‹é«˜å¼·åº¦ Statinï¼ˆå¦‚ Atorvastatin 40-80 mg æˆ– Rosuvastatin 20-40 mgï¼‰ã€‚\n2. è‹¥ 6-8 é€±å¾Œ LDL-C æœªé™è‡³ <55 mg/dLï¼Œåˆä½µ Ezetimibe 10 mgã€‚\n3. è‹¥ä»æœªé”æ¨™ï¼Œè€ƒæ…® PCSK9 æŠ‘åˆ¶åŠ‘ï¼ˆå¦‚ Evolocumabï¼‰æˆ– Inclisiranï¼ˆsiRNAï¼‰ã€‚\n4. è¿½è¹¤è‚åŠŸèƒ½åŠ CK å€¼ï¼Œæ¯ 3 å€‹æœˆä¸€æ¬¡ã€‚";
        }
        else if (hasCondition(conditions, ['å¿ƒè‚Œæ¢—å¡', 'ä¸­é¢¨', 'è…¦ä¸­é¢¨', 'å‘¨é‚Šå‹•è„ˆç–¾ç—…', 'PCI', 'CABG', 'ASCVD', 'æ–‘å¡Š â‰¥50%', 'ç‹¹çª„ â‰¥50%'])) {
            risk = "éå¸¸é«˜é¢¨éšª";
            target = 70;
            color = "warning";
            advice = "1. èµ·å§‹é«˜å¼·åº¦ Statinï¼ˆå¦‚ Atorvastatin 40-80 mgï¼‰ã€‚\n2. è‹¥æœªé”æ¨™ï¼Œåˆä½µ Ezetimibe 10 mgã€‚\n3. ç›®æ¨™ LDL-C <70 mg/dLï¼Œè¿½è¹¤ 6-8 é€±å¾Œèª¿æ•´åŠ‘é‡ã€‚\n4. å¼·èª¿ç”Ÿæ´»å‹æ…‹ä»‹å…¥ï¼ˆå¦‚é£²é£Ÿæ§åˆ¶èˆ‡é‹å‹•ï¼‰ã€‚";
        }
        else if (hasCondition(conditions, ['ç³–å°¿ç—…', 'æ…¢æ€§è…è‡Ÿç—…', 'CKD']) || (ldlC && ldlC >= 190) || (eGFR && eGFR < 60)) {
            risk = "é«˜é¢¨éšª";
            target = 100;
            color = "primary";
            advice = "1. èµ·å§‹ä¸­è‡³é«˜å¼·åº¦ Statinï¼ˆå¦‚ Atorvastatin 20-40 mgï¼‰ã€‚\n2. è‹¥ LDL-C >100 mg/dLï¼Œè€ƒæ…®åˆä½µ Ezetimibe æˆ– Bempedoic Acidã€‚\n3. æ¯ 6 å€‹æœˆè¿½è¹¤è¡€è„‚èˆ‡è…åŠŸèƒ½ã€‚\n4. åŠ å¼·ç³–å°¿ç—…èˆ‡è¡€å£“æ§åˆ¶ã€‚";
        }
        else if (riskFactors >= 2) {
            risk = "ä¸­é¢¨éšª";
            target = 115;
            color = "info";
            advice = "1. ç”Ÿæ´»å‹æ…‹æ”¹è®Š 3-6 å€‹æœˆï¼ˆä½è„‚ã€ä½ç³–é£²é£Ÿã€è¦å¾‹é‹å‹•ã€é«”é‡æ§åˆ¶ï¼‰ã€‚\n2. è‹¥ LDL-C ä» >115 mg/dLï¼Œè€ƒæ…®èµ·å§‹ä¸­å¼·åº¦ Statinï¼ˆå¦‚ Atorvastatin 10-20 mgï¼‰ã€‚\n3. æ¯ 6-12 å€‹æœˆè¿½è¹¤è¡€è„‚ã€‚\n4. å„ªå…ˆæˆ’è¸èˆ‡è¡€å£“ç®¡ç†ã€‚";
        }
        else {
            risk = "ä½é¢¨éšª";
            target = 130;
            color = "success";
            advice = "1. ç”Ÿæ´»å‹æ…‹èª¿æ•´ï¼ˆå¥åº·é£²é£Ÿã€è¦å¾‹é‹å‹•ã€é¿å…é«˜è†½å›ºé†‡é£Ÿç‰©ï¼‰ã€‚\n2. ç„¡éœ€ç«‹å³ç”¨è—¥ï¼Œå®šæœŸè¿½è¹¤è¡€è„‚æ¯ 12 å€‹æœˆã€‚\n3. è‹¥æœ‰å±éšªå› å­ï¼Œå»ºè­°æ§åˆ¶è¡€å£“èˆ‡æˆ’è¸ã€‚";
        }

        if (ldl !== 'N/A' && parseFloat(ldl) > target) {
            advice += "\n\nã€ç›®å‰ LDL-C æœªé”æ¨™ã€‘å»ºè­°ç«‹å³è©•ä¼°èª¿æ•´æ²»ç™‚æ–¹æ¡ˆï¼Œä¸¦åœ¨ 6-8 é€±å¾Œè¤‡æª¢è¡€è„‚ã€‚";
        }

        return { risk, target, color, advice };
    }

    async function loadAllPatients() {
        const listBody = document.getElementById('patient-list');
        listBody.innerHTML = "";

        for (const id of patientIds) {
            try {
                const pRes = await fetch(`${FHIR_BASE}/Patient/${id}`)
                    .catch(() => { throw new Error('ç—…äººè³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨'); });
                if (!pRes.ok) throw new Error(`ç—…äººè³‡æ–™è®€å–å¤±æ•—: ${pRes.status}`);
                const patient = await pRes.json();

                const cRes = await fetch(`${FHIR_BASE}/Condition?patient=Patient/${id}`)
                    .catch(() => { throw new Error('è¨ºæ–·è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨'); });
                const cBundle = await cRes.json();
                const conditions = cBundle.entry ? cBundle.entry.map(e => e.resource) : [];
                const condText = conditions.map(c => c.code?.text || 'æœªçŸ¥è¨ºæ–·').join(', ') || 'ç„¡è¨ºæ–·è³‡æ–™';

                const oRes = await fetch(`${FHIR_BASE}/Observation?patient=Patient/${id}&code=13457-7,2085-9,8480-6,8462-4,50044-7,69405-9,2887-8&_sort=-date`)
                    .catch(() => { throw new Error('æª¢é©—è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨'); });
                const oBundle = await oRes.json();
                const observations = oBundle.entry ? oBundle.entry.map(e => e.resource) : [];

                const ldlObs = observations.find(obs => obs.code?.coding?.[0]?.code === '13457-7' || obs.code?.text?.toLowerCase().includes('ldl'));
                const ldl = ldlObs ? ldlObs.valueQuantity?.value : 'N/A';

                const mRes = await fetch(`${FHIR_BASE}/MedicationRequest?patient=Patient/${id}`)
                    .catch(() => { throw new Error('ç”¨è—¥è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨'); });
                const mBundle = await mRes.json();
                const medications = mBundle.entry ? mBundle.entry.map(e => e.resource.medicationCodeableConcept?.text || 'æœªçŸ¥è—¥ç‰©') : [];

                const { risk, target, color, advice } = calculateRiskLevel(patient, conditions, observations, medications, ldl);

                patientDataStore[id] = { name: patient.name?.[0]?.text || 'æœªçŸ¥å§“å', risk, target, ldl, cond: condText, advice, color, medications };

                const status = (ldl !== 'N/A' && parseFloat(ldl) > target) ? 'ğŸ”´ æœªé”æ¨™' 
                              : (ldl !== 'N/A' ? 'ğŸŸ¢ å·²é”æ¨™' : 'N/A');
                listBody.innerHTML += `
                    <tr class="clickable-row" onclick="showDetail('${id}')">
                        <td><strong>${patient.name?.[0]?.text || 'æœªçŸ¥'}</strong></td>
                        <td><span class="badge bg-${color} risk-tag">${risk}</span></td>
                        <td>${ldl}</td>
                        <td>${target}</td>
                        <td>${status}</td>
                    </tr>
                `;
            } catch (e) {
                console.error(`è®€å–ç—…äºº ${id} å¤±æ•—`, e);
                listBody.innerHTML += `
                    <tr>
                        <td colspan="5" class="text-danger">è®€å– ${id} å¤±æ•—: ${e.message}</td>
                    </tr>
                `;
            }
        }
        document.getElementById('loading-status').innerText = "è³‡æ–™æ›´æ–°å®Œæˆ";
    }

    function showDetail(id) {
        const data = patientDataStore[id];
        if (!data) return;

        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('detail-pane').style.display = 'block';

        document.getElementById('det-name').innerText = data.name;
        document.getElementById('det-cond').innerText = data.cond;
        document.getElementById('det-ldl').innerText = data.ldl;
        document.getElementById('det-target').innerText = data.target;
        document.getElementById('det-advice').innerText = data.advice;

        // ç”¨è—¥æ¸…å–®
        const medList = document.getElementById('det-medications');
        medList.innerHTML = '';
        if (data.medications.length > 0) {
            data.medications.forEach(med => {
                medList.innerHTML += `<li class="list-group-item medication-item">${med}</li>`;
            });
        } else {
            medList.innerHTML = '<li class="list-group-item text-muted">ç„¡ç”¨è—¥è¨˜éŒ„</li>';
        }

        // é€²åº¦æ¢è¨ˆç®—
        const ldlValue = data.ldl !== 'N/A' ? parseFloat(data.ldl) : 0;
        const targetValue = parseFloat(data.target);
        let percentage = targetValue > 0 ? Math.min((targetValue / ldlValue) * 100, 150) : 0; // é¿å…é™¤ä»¥ 0
        let progressColor = 'bg-success';
        let progressText = 'é”æˆç‡ï¼š' + percentage.toFixed(0) + '%';

        if (ldlValue > targetValue) {
            progressColor = 'bg-danger';
            progressText = 'æœªé”æ¨™ (' + (ldlValue - targetValue).toFixed(1) + ' mg/dL å·®è·)';
            percentage = Math.min(100 - ((ldlValue - targetValue) / targetValue * 100), 100);
        } else if (percentage > 100) {
            progressColor = 'bg-success';
            progressText = 'å·²è¶…æ¨™é”æˆ (' + (percentage - 100).toFixed(0) + '%)';
        }

        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = percentage + '%';
        progressBar.className = 'progress-bar ' + progressColor;
        progressBar.setAttribute('aria-valuenow', percentage);
        document.getElementById('progress-text').innerText = progressText;

        // æŸ±ç‹€åœ–
        const ctx = document.getElementById('ldl-chart').getContext('2d');
        if (chartInstance) chartInstance.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ç›®å‰ LDL-C', 'ç›®æ¨™å€¼'],
                datasets: [{
                    label: 'LDL-C (mg/dL)',
                    data: [ldlValue, targetValue],
                    backgroundColor: [ldlValue > targetValue ? 'rgba(220, 53, 69, 0.8)' : 'rgba(40, 167, 69, 0.8)', 'rgba(0, 123, 255, 0.6)'],
                    borderColor: [ldlValue > targetValue ? 'rgb(220, 53, 69)' : 'rgb(40, 167, 69)', 'rgb(0, 123, 255)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'mg/dL' } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // å•Ÿå‹•è¼‰å…¥
    loadAllPatients();
</script>

</body>
</html>